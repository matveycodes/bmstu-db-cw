\chapter{Конструкторский раздел}

В данном разделе будет спроектирована база данных, которая требуется для реализации поставленной задачи, и описаны ее ограничения. Также будет описана используемая ролевая модель.

\section{Диаграмма проектируемой базы данных}

На рисунке~\ref{img:db} представлена диаграмма проектируемой базы данных.

\includeimage
    {db}
    {f}
    {H}
    {\textwidth}
    {Диаграмма проектируемой базы данных}

\section{Сущности проектируемой базы данных}

\subsection{Пользователь (таблица users)}

Сущность пользователя содержит следующие поля.

\begin{enumerate}
    \item id --- уникальный идентификатор. Тип: число. Обязательное поле.
    \item status --- статус пользователя. Тип: строка. Обязательное поле. Может принимать одно из двух возможных значений: <<active>> (активный) и <<blocked>> (заблокированный).
    \item password\_hash --- хэш пароля. Тип: строка. Обязательное поле.
    \item date\_joined --- дата регистрации пользователя в системе. Тип: дата со временем. Обязательное поле.
    \item middle\_name --- отчество. Тип: строка.
    \item first\_name --- имя. Тип: строка. Обязательное поле.
    \item last\_name --- фамилия. Тип: строка.
    \item email --- адрес электронной почты. Тип: строка. Обязательное поле.
    \item phone --- номер телефона. Тип: строка. Обязательное поле.
    \item birthdate --- дата рождения. Тип: дата. Обязательное поле.
\end{enumerate}

\subsection{Сотрудник клиентской поддержки (таблица supports)}

Сущность сотрудника клиентской поддержки содержит те же поля, что и сущность пользователя, за исключением даты рождения (birthdate). Поля отчества (middle\_name) и фамилии (last\_name) являются обязательными.

\subsection{Механик (таблица technicians)}

Сущность механика содержит те же поля, что и сущность пользователя, за исключением даты рождения (birthdate). Поля отчества (middle\_name) и фамилии (last\_name) являются обязательными.

\subsection{Администратор (таблица admins)}

Сущность администратора содержит те же поля, что и сущность пользователя, за исключением даты рождения (birthdate). Поля отчества (middle\_name) и фамилии (last\_name) являются обязательными.

\subsection{Токен авторизации (таблица auth\_tokens)}

Сущность токена авторизации содержит следующие поля.

\begin{enumerate}
    \item id --- уникальный идентификатор. Тип: число. Обязательное поле.
    \item user\_id --- уникальный идентификатор пользователя. Тип: число. Обязательное поле.
    \item hash --- хэш. Тип: строка. Обязательное поле.
    \item date\_expired --- дата окончания действия. Тип: дата со временем. Обязательное поле.
    \item date\_last\_used --- дата последнего использования. Тип: дата со временем.
\end{enumerate}

\subsection{Сообщение в чате (таблица chat\_messages)}

Сущность сообщения в чате содержит следующие поля.

\begin{enumerate}
    \item id --- уникальный идентификатор. Тип: число. Обязательное поле.
    \item user\_id --- уникальный идентификатор пользователя, отправившего сообщение. Тип: число.
    \item support\_id --- уникальный идентификатор сотрудника клиентской поддержки. Тип: число.
    \item message --- текст сообщения. Тип: строка. Обязательное поле.
    \item date --- дата отправки сообщения. Тип: дата со временем. Обязательное поле.
\end{enumerate}

\subsection{Бронирование (таблица bookings)}

Сущность бронирования содержит следующие поля.

\begin{enumerate}
    \item id --- уникальный идентификатор. Тип: число. Обязательное поле.
    \item user\_id --- уникальный идентификатор пользователя. Тип: число. Обязательное поле.
    \item scooter\_id --- уникальный идентификатор электросамоката. Тип: число. Обязательное поле.
    \item date\_started --- дата начала бронирования. Тип: дата со временем. Обязательное поле.
    \item date\_finished --- дата окончания бронирования. Тип: дата со временем.
\end{enumerate}

\subsection{Аренда (таблица rentals)}

Сущность аренды содержит следующие поля.

\begin{enumerate}
    \item id --- уникальный идентификатор. Тип: число. Обязательное поле.
    \item user\_id --- уникальный идентификатор пользователя. Тип: число. Обязательное поле.
    \item scooter\_id --- уникальный идентификатор пользователя. Тип: число. Обязательное поле.
    \item start\_price --- стоимость начала аренды. Тип: деньги. Обязательное поле.
    \item per\_minute\_price --- стоимость аренды за минуту. Тип: деньги. Обязательное поле.
    \item date\_started --- дата начала аренды. Тип: дата со временем. Обязательное поле.
    \item date\_finished --- дата завершения аренды. Тип: дата со временем.
\end{enumerate}

\subsection{Зона ограничения скорости (таблица restricted\_zones)}

Сущность зоны ограничения скорости содержит следующие поля.

\begin{enumerate}
    \item id --- уникальный идентификатор. Тип: число. Обязательное поле.
    \item polygon --- координаты зоны. Тип: GeoJSON. Обязательное поле.
    \item speed\_limit --- максимальная скорость. Тип: число. Обязательное поле.
\end{enumerate}

\subsection{Парковки (таблица parking\_places)}

Сущность парковки содержит следующие поля.

\begin{enumerate}
    \item id --- уникальный идентификатор. Тип: число. Обязательное поле.
    \item location --- координаты парковки. Тип: GeoJSON. Обязательное поле.
\end{enumerate}

\subsection{Настройка (таблица settings)}

Сущность настройки содержит следующие поля.

\begin{enumerate}
    \item name --- название. Тип: строка. Обязательное поле.
    \item value --- значение. Тип: JSON. Обязательное поле.
\end{enumerate}

\subsection{Электросамокат (таблица scooters)}

Сущность электросамоката содержит следующие поля.

\begin{enumerate}
    \item id --- уникальный идентификатор. Тип: число. Обязательное поле.
    \item model\_id --- уникальный идентификатор модели. Тип: число. Обязательное поле.
    \item status --- статус. Тип: строка. Обязательное поле. Может принимать одно из двух значений: <<active>> (активный) и <<disabled>> (деактивированный).
    \item image\_link --- ссылка на фотографию самоката. Тип: строка.
    \item number --- номер самоката. Тип: строка. Обязательное поле.
\end{enumerate}

\subsection{Модель электросамоката (таблица scooter\_models)}

Сущность модели электросамоката содержит следующие поля.

\begin{enumerate}
    \item id --- уникальный идентификатор. Тип: число. Обязательное поле.
    \item manufacturer\_id --- уникальный идентификатор производителя. Тип: число. Обязательное поле.
    \item title --- название модели. Тип: строка. Обязательное поле.
\end{enumerate}

\subsection{Производитель электросамоката (таблица scooter\_manufacturers)}

Сущность производителя электросамоката содержит следующие поля.

\begin{enumerate}
    \item id --- уникальный идентификатор. Тип: число. Обязательное поле.
    \item title --- название. Тип: строка. Обязательное поле.
\end{enumerate}

\subsection{Запись в истории перемещений (таблица pings)}

Сущность записи в истории перемещений содержит следующие поля.

\begin{enumerate}
    \item id --- уникальный идентификатор. Тип: число. Обязательное поле.
    \item scooter\_id --- уникальный идентификатор самоката, отправившего информацию. Тип: число. Обязательное поле.
    \item date --- дата создания записи. Тип: дата со временем. Обязательное поле.
    \item meta\_info --- информация о техническом состоянии электросамоката. Тип: JSON. Обязательное поле.
    \item location --- геолокация электросамоката. Тип: GeoJSON. Обязательное поле.
    \item battery\_level --- уровень заряда батареи. Тип: число. Обязательное поле.
\end{enumerate}

\section{Ограничения целостности базы данных}

TODO

\section{Описание триггера}

На рисунке~\ref{img:trigger} представлена схема алгоритма работы триггера, который не позволяет удалять пользователей, которые имеют активные (незавершенные) аренды.

\includeimage
    {trigger}
    {f}
    {H}
    {.5\textwidth}
    {Схема алгоритма работы триггера}

\section{Ролевая модель}

TODO

\section*{Вывод}

В данном разделе была спроектирована база данных для разрабатываемого приложения, а так же рассмотрены способы обеспечения ее целостности и ролевая модель.